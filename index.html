<!doctype html>
<html>
  <body>
    <div id="container" style="font:12px Arial;color:#888">Exporting page dataâ€¦</div>
    <script>
    (function(){
      // Read text inputs from the Style panel: set these when you insert the viz in Looker Studio.
      // Looker Studio injects dscc runtime; dscc.subscribeToData gives us data + style.
      function hmac(secret, msg){
        return crypto.subtle.importKey('raw', new TextEncoder().encode(secret),
          {name:'HMAC', hash:'SHA-256'}, false, ['sign']
        ).then(k => crypto.subtle.sign('HMAC', k, new TextEncoder().encode(msg)))
         .then(sig => Array.from(new Uint8Array(sig)).map(b=>b.toString(16).padStart(2,'0')).join(''));
      }

      function send(payload, url, secret){
        const body = JSON.stringify(payload);
        return hmac(secret, body).then(sig =>
          fetch(url, {method:'POST', headers:{'Content-Type':'application/json','X-Signature':sig}, body})
        );
      }

      function draw(data){
        const style = data.style || {};
        const ingestUrl = style.ingestUrl || "";      // set in Style
        const sharedSecret = style.sharedSecret || ""; // set in Style
        const reportId = style.reportId || "";         // set in Style

        const dims = (data.fields && data.fields.dimensions) || [];
        const mets = (data.fields && data.fields.metrics) || [];
        const fields = dims.concat(mets).map(f => f.name);
        const rows = (data.tables && data.tables.DEFAULT || []).map(r => {
          const o={};
          r.forEach((c,i)=>o[fields[i]] = c && c.v != null ? String(c.v) : "");
          return o;
        });

        const first = rows[0] || {};
        const tool = first["Tools"] || first["Tool"] || first["Connector"] || first["Name"] || "";

        const payload = (rows.length===1)
          ? { report_id: reportId, page_id: data.themeId || "", tool, fields: first }
          : { report_id: reportId, page_id: data.themeId || "", tool: "", fields: { fields, rows } };

        const el = document.getElementById("container");
        if(!ingestUrl || !sharedSecret){
          el.textContent = "Configure ingestUrl & sharedSecret in Style";
          return;
        }
        send(payload, ingestUrl, sharedSecret)
          .then(()=> el.textContent = "Exported snapshot")
          .catch(()=> el.textContent = "Export failed (check secret/url)");
      }

      // Subscribe to data updates from Looker Studio
      dscc.subscribeToData(draw, { transform: dscc.transform });
    })();
    </script>
  </body>
</html>
